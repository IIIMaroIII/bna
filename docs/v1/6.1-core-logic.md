### ================================= Core logic (MVP v1) =================================

Этот документ описывает **ядро поведения продукта** (что происходит в основных сценариях),
без привязки к UI и без технической реализации.

Ссылки (вставить позже):
- MVP: <!-- TODO link to 4-MVP.md -->
- FR: <!-- TODO link to 5-FR-for-MVP.md -->
- UI Map v1: <!-- TODO link to 6-ui-map-v1.md -->
- Domain Rules: <!-- TODO link to 7.3-MVP-domain-model-rules.md -->

---

## 0) Главные понятия (фиксируем)

### Company (tenant boundary)
- Все данные всегда принадлежат Company.
- Любые чтение/запись выполняются только в рамках Company текущего пользователя.

### Роли (RBAC)
- Owner: максимум прав + admins management + company settings + allowed networks + доступ/trial
- Admin: управление users/teams/projects/assignments + отчёты
- Employee: clock-in/out + просмотр своих часов

### Access Status (глобальный режим компании)
- FULL: обычная работа по RBAC
- READ_ONLY: вход разрешён, но любые Create/Update/Deactivate и clock-in/out запрещены
- BLOCKED: вход в App Area запрещён (только экран “Access blocked” + logout)

> Access Status — это не роль. Это “режим компании”, накладываемый поверх RBAC.

### WorkSession != AUTH session
- AUTH session: состояние логина (cookies/tokens).
- WorkSession: рабочая смена (создаётся только при clock-in).

### Work mode (сотрудник)
- ONSITE: применяется политика Wi-Fi
- REMOTE: Wi-Fi проверка не требуется

---

## 1) Public Area → App Area (входные сценарии)

### Регистрация (Sign Up)
- Создаётся Company + User(role=OWNER).
- Company получает trial параметры (trial_ends_at, subscription_status=TRIAL, access_status=FULL).
- После успешной регистрации Owner попадает в App Area.

### Логин (Sign In)
- Owner входит по email/password.
- Admin/Employee входят по выданным credentials (логин/пароль или эквивалент).

### Проверки при входе
- Если User.status=INACTIVE → вход запрещён.
- Если Company.access_status=BLOCKED → вход в App Area запрещён (экран blocked).
- Если Company.access_status=READ_ONLY → вход разрешён, но действия ограничены (см. раздел 2).

---

## 2) Глобальные ограничения доступа (Access Status)

### FULL
- всё работает по RBAC.

### READ_ONLY
- разрешены: Read/List (просмотр данных)
- запрещены:
  - любые Create/Update/Deactivate (Users/Teams/Projects/Assignments/Networks и т.п.)
  - clock-in и clock-out
- UI должен показывать disabled actions + понятное объяснение причины.

### BLOCKED
- App Area недоступна.
- доступен экран “Access blocked”:
  - logout
  - контакты/поддержка (минимально)

---

## 3) Управление людьми и структурой (Admin/Owner)

### Users (Employees)
- Admin/Owner:
  - создаёт Employee
  - деактивирует Employee (status=INACTIVE)
- Деактивированный пользователь:
  - не может входить
  - не может clock-in/out
  - если у него была активная WorkSession → см. авто-закрытие (раздел 7)

### Admins (Owner-only)
- Owner:
  - создаёт Admin
  - деактивирует Admin
- Safety:
  - нельзя деактивировать последнего активного Owner компании

---

## 4) Teams (модель доступа к проектам)

### Team
- Admin/Owner создаёт Team.
- Team может быть активной/неактивной (soft-delete через status).

### TeamMember (связь User↔Team)
- Admin/Owner добавляет пользователя в Team (TeamMember.status=ACTIVE).
- Убирает пользователя из Team (TeamMember.status=INACTIVE).
- Ограничение:
  - Employee может состоять в нескольких командах,
  - но не превышая Company.max_active_teams_per_employee (active team memberships).

> Team — это структура доступа и группировка.
> Это НЕ новая “человеческая роль” (нет TeamLead в MVP v1).

---

## 5) Projects + Assignments (Admin/Owner)

### Project
- Admin/Owner создаёт Project.
- Project активируется/деактивируется через status (soft-delete).

### ProjectTeamAssignment (связь Team↔Project)
- Admin/Owner назначает Team на Project (создаёт ProjectTeamAssignment.status=ACTIVE).
- Снимает назначение (status=INACTIVE).

Ограничение MVP v1:
- **1 Project = 1 активная Team assignment**
  - у Project может быть только один ACTIVE ProjectTeamAssignment одновременно.

---

## 6) Правило доступа Employee к проектам (ключевое)

Employee видит проект в списке выбора для clock-in, только если одновременно истинно:
- Employee состоит минимум в одной команде: TeamMember.status=ACTIVE
- Проект активен: Project.status=ACTIVE
- Существует активное назначение: ProjectTeamAssignment.status=ACTIVE
- И назначенная на Project команда — та, в которой состоит Employee

Если у Employee нет активных команд → список проектов пуст.

---

## 7) Учёт рабочего времени (WorkSession)

### Clock-in (Employee)
Clock-in разрешён только если выполнены условия:

**A) Глобальные**
- Company.access_status = FULL
- User.status = ACTIVE

**B) Доменные**
- У Employee нет активной WorkSession (одна активная смена на человека).
- Employee выбирает Project из доступных (см. раздел 6).
- Project.status = ACTIVE

**C) Work location policy**
- Если Employee.work_mode = REMOTE → Wi-Fi проверка не требуется.
- Если Employee.work_mode = ONSITE и Company.work_location_policy = WIFI_REQUIRED:
  - список AllowedCompanyNetwork не пуст
  - текущая сеть входит в разрешённые
  - иначе clock-in запрещён с понятной причиной

**Результат clock-in**
- Создаётся WorkSession:
  - status=ACTIVE
  - start_time = now
  - end_time = null
  - project_id = выбранный проект
  - team_id = команда, назначенная на выбранный проект (фиксируем историчность)
  - is_work_location_verified = true/false (в зависимости от политики)
- Employee становится “clocked-in”.

---

### Clock-out (Employee)
Clock-out разрешён только если:
- Company.access_status = FULL
- User.status = ACTIVE
- существует активная WorkSession

**Результат clock-out**
- WorkSession:
  - end_time = now
  - status = INACTIVE
  - duration_ms рассчитывается автоматически
  - close_reason = MANUAL

---

### Корректировка времени (Admin/Owner) — опционально для MVP
Если включено в MVP:
- Admin/Owner может корректировать только INACTIVE WorkSession.
- Любая корректировка фиксирует:
  - updated_at
  - updated_by_user_id
- duration_ms пересчитывается автоматически, ручное редактирование duration запрещено.

---

## 8) Просмотр данных (Read модели)

### Employee
- видит:
  - свой статус (clocked-in/out)
  - свои команды (active)
  - доступные проекты (по правилу доступа)
  - свою историю WorkSession

### Admin/Owner
- видит по компании:
  - список пользователей/команд/проектов
  - активные WorkSession (кто сейчас clocked-in)
  - отчёты по сотрудникам
  - отчёты по проектам (агрегации)
- Owner дополнительно:
  - admins management
  - company settings
  - allowed networks

---

## 9) Soft-delete и статусы (единый принцип)

- “Удаление” бизнес-объектов = перевод status в INACTIVE.
- WorkSession не удаляется никогда.
- INACTIVE связи (TeamMember / ProjectTeamAssignment) сохраняются для истории.
- Активные выборки = фильтр status=ACTIVE.

---

## 10) Авто-закрытие активной WorkSession (edge cases)

Если у сотрудника есть ACTIVE WorkSession, система должна автоматически закрывать её (auto clock-out),
если произошло одно из событий:

- User.status стал INACTIVE
- TeamMember.status стал INACTIVE для team_id активной WorkSession
- Team.status стал INACTIVE для team_id активной WorkSession
- Project.status стал INACTIVE для project_id активной WorkSession
- ProjectTeamAssignment.status стал INACTIVE для пары (team_id, project_id) активной WorkSession
- Company.access_status стал READ_ONLY или BLOCKED (рекомендуем закрывать активные смены, чтобы не зависали)

**Как закрываем автоматически**
- end_time = now
- status = INACTIVE
- duration_ms пересчитывается автоматически
- close_reason = AUTO_* (в зависимости от причины)

---

## 11) Что не входит в Core logic MVP v1 (сознательно)

- расчёт зарплат/налогов/авансов/бонусов
- отпуск/больничный/выходные (HR контур)
- уведомления (notifications)
- склад/остатки/комплектующие/закупки
- накладные и отправка поставщикам
- экспорт PDF/Excel
- мобильное приложение
- микросервисы и high-load оптимизация
