### ================================= MVP Domain Model Rules =================================

## Термины (фиксируем)
    - TeamMember = связь “User состоит в Team”
    - ProjectTeamAssignment = связь “Team допущена к Project”
    - App Area = часть приложения **после авторизации** (внутренний кабинет: Employee/Admin/Owner)

### Layer A — Data integrity / Tenant boundary ###

## A1. Company boundary (изоляция данных)
- `A1.1`: Каждая сущность домена (User/Team/TeamMember/Project/ProjectTeamAssignment/WorkSession/AllowedCompanyNetwork) обязана иметь `company_id`.
- `A1.2`: Любая операция чтения/записи обязана работать только в рамках `company_id` текущего пользователя.
- `A1.3`: Запрещены связи между сущностями разных компаний (например нельзя связать Team из одной компании с User из другой).

## A2. Уникальности и ограничения
- `A2.1`: `login` пользователя должен быть уникален **внутри одной компании** (нельзя создать двух пользователей с одинаковым login в одной company).
- `A2.2`: У одного Employee одновременно может быть только 1 активная WorkSession (нельзя иметь две “идущие” смены параллельно).
- `A2.3`: У одного Project одновременно может быть только 1 активная связь ProjectTeamAssignment (то есть проект “закреплён” за одной командой).
- `A2.4`: Если нужно “добавить сотрудника на проект”, это делается так: сотрудника добавляют в Team, которая уже назначена на этот Project (через TeamMember), а не создают отдельные назначения Employee→Project.
- `A2.5`: AllowedCompanyNetwork для компании — это список разрешённых сетей (понятно как “массив строк `network_identifier[]`”; физически можно хранить как отдельные записи или как массив в Company).
- `A2.6`: Один и тот же `network_identifier` не должен повторяться среди активных разрешённых сетей одной компании.
- `A2.7`: Employee может состоять в нескольких командах.
- `A2.8`: Максимум активных команд для одного Employee задаётся настройкой компании:
    - `Company.max_active_teams_per_employee` (например 3 или 5)
    - система должна запрещать добавление в новую команду, если лимит превышен.

## A3. Статусы и “soft-delete” (единый принцип)
- `A3.1`: Все сущности используют единый статус: `status = ACTIVE | INACTIVE`.
- `A3.2`: “Удаление” в бизнес-смысле = перевод `status` в INACTIVE (физически записи не удаляем).
- `A3.3`: TeamMember.status=INACTIVE означает “сотрудник больше не состоит в команде”, но запись остаётся для истории.
- `A3.4`: ProjectTeamAssignment.status=INACTIVE означает “команда больше не допущена к проекту”, но запись остаётся для истории.
- `A3.5`: User.status=INACTIVE означает “пользователь деактивирован” (не может входить/работать), запись остаётся.
- `A3.6`: WorkSession не удаляется никогда; она либо ACTIVE (идёт), либо INACTIVE (закрыта).

## A4. Как хранить INACTIVE связи
- `A4.1`: INACTIVE TeamMember/ProjectTeamAssignment хранятся как обычные записи в той же сущности (никаких “отдельных массивов” не нужно).
- `A4.2`: “Активные связи” — это просто фильтр по `status=ACTIVE`.
- `A4.3`: “История связей” — это список записей, включая INACTIVE.
- `A4.4`: WorkSession фиксирует `team_id` на момент clock-in (историчность), даже если потом сотрудника перевели в другие команды.

### Layer B — RBAC (Role-based access control) + операции ###

## B1. Зоны доступа
- `B1.1`: Public Area (без логина): Home/Features/Pricing/Contacts/Feedback.
- `B1.2`: App Area (после логина): Employee UI / Admin Console / Owner extensions.

## B2. Employee — права
- `B2.1`: `WorkSession`
  - Create: разрешено (clock-in)
  - Update: разрешено (clock-out только своей активной сессии)
  - Read/List: разрешено (только свои сессии)
  - Deactivate: запрещено
- `B2.2`: `Projects` (доступные)
  - Read/List: разрешено (только те, к которым есть доступ через команды и назначение команды на проект)
  - Create/Update/Deactivate: запрещено
- `B2.3`: `Team/TeamMember`
  - Read/List: разрешено (видит, в каких командах состоит)
  - Create/Update/Deactivate: запрещено
- `B2.4`: `Users/Networks/Assignments`
  - любые операции: запрещено

## B3. Admin — права
- `B3.1`: `User (Employee)`
  - Create: разрешено
  - Read/List: разрешено
  - Update: разрешено (минимально: профиль/логин при необходимости)
  - Deactivate: разрешено
- `B3.2`: `Team`
  - Create: разрешено
  - Read/List: разрешено
  - Update: разрешено
  - Deactivate: разрешено
- `B3.3`: `TeamMember`
  - Create: разрешено (добавить пользователя в команду)
  - Read/List: разрешено
  - Update: опционально (если появятся поля связи)
  - Deactivate: разрешено (убрать из команды)
- `B3.4`: `Project`
  - Create: разрешено
  - Read/List: разрешено
  - Update: разрешено
  - Deactivate: разрешено
- `B3.5`: `ProjectTeamAssignment`
  - Create: разрешено (назначить команду на проект)
  - Read/List: разрешено
  - Update: опционально (если появятся поля связи)
  - Deactivate: разрешено (снять команду с проекта)
- `B3.6`: `WorkSession`
  - Read/List: разрешено (по компании, отчёты)
  - Update: разрешено (корректировка времени, если включено в MVP)
  - Create/Deactivate: запрещено (создаёт только clock-in; “удаления” нет)
- `B3.7`: `AllowedCompanyNetwork`
  - Create/Update/Deactivate: запрещено (Owner-only)

## B4. Owner — права
- `B4.1`: Всё, что Admin — разрешено.
- `B4.2`: `User (Admin)`
  - Create/Read/List/Update/Deactivate: разрешено (управление администраторами внутри своей company)
- `B4.3`: `Company settings`
  - Update: разрешено (policy, лимиты, отрасль и т.п.)
- `B4.4`: `AllowedCompanyNetwork`
  - Create/Read/List/Update/Deactivate: разрешено

### Layer C — Domain Rules (логика продукта) ###

## C1. Регистрация компании
- `C1.1`: Регистрация создаёт Company + User(role=OWNER).
- `C1.2`: При регистрации Company обязательно выбирается `industry` (отрасль).
  - Поле: `Company.industry` (enum или строка из справочника).
- `C1.3`: У Company всегда должен быть хотя бы один ACTIVE Owner.

## C2. Пользователи
- `C2.1`: User.status=INACTIVE → вход в App Area запрещён.
- `C2.2`: Admin/Owner создает Employee и принадлежит company.
- `C2.3`: Admin добавляется/редактируется/деактивируется только Owner (внутри своей company).

## C3. Команды и TeamMember
- `C3.1`: Добавить пользователя в команду можно только если User.status=ACTIVE.
- `C3.2`: В TeamMember можно добавлять пользователей role ∈ {EMPLOYEE, ADMIN}
- `C3.3`: Один пользователь может быть в нескольких командах, но не превышая `Company.max_active_teams_per_employee`.
- `C3.4`: Убрать пользователя из команды = TeamMember.status=INACTIVE.

## C4. Проекты и ProjectTeamAssignment
- `C4.1`: ProjectTeamAssignment можно создать только если Team.status=ACTIVE и Project.status=ACTIVE.
- `C4.2`: Проект может иметь только одну активную назначенную команду (см. A2.3).
- `C4.3`: Если нужно “добавить сотрудника к проекту” — добавляем его в Team, которая назначена на проект (см. A2.4).
- `C4.4`: Снять команду с проекта = ProjectTeamAssignment.status=INACTIVE.
- `C4.5`: Project.status=INACTIVE → новые clock-in в этот проект запрещены.

## C5. Доступ Employee к проектам
- `C5.1`: Employee видит проекты только если:
  - он состоит хотя бы в одной TeamMember.status=ACTIVE 
  - проект Project.status=ACTIVE
  - у проекта Project.status=ACTIVE, ProjectTeamAssignment на одну из его команд (в вашем правиле “1 проект = 1 команда” это значит: проект виден тем, кто состоит в этой конкретной команде)
- `C5.2`: Если у employee нет активных команд → список проектов пуст.

## C6. WorkSession (clock-in / clock-out)
Важно: WorkSession — это **рабочая смена**, а не **сессия логина**.

- `C6.1`: Clock-in создаёт WorkSession:
  - status=ACTIVE
  - start_time = now
  - end_time = null
  - team_id = команда, назначенная на выбранный проект
- `C6.2`: Clock-out завершает WorkSession:
  - end_time = now
  - status=INACTIVE
  - duration_ms считается автоматически (ручное редактирование duration запрещено)
- `C6.3`: У Employee может быть только одна WorkSession.status=ACTIVE (см. A2.2).
- `C6.4`: Clock-in запрещён, если уже есть WorkSession.status=ACTIVE.
- `C6.5`: Clock-out запрещён, если нет WorkSession.status=ACTIVE. **??? ввести null ???**
- `C6.6`: Employee не может редактировать start/end/duration.
- `C6.7`: Admin/Owner может корректировать только завершённые (INACTIVE) WorkSession -> *WorkSession.status=INACTIVE*.
- `C6.8`: Любая корректировка WorkSession фиксирует:
  - updated_at
  - updated_by_user_id

## C7. Work location policy + Remote
Добавляем в User поле:
- `work_mode: ONSITE | REMOTE`

Правила:
- `C7.1`: Company.work_location_policy применяется только к ONSITE сотрудникам.
- `C7.2`: Если user.work_mode=REMOTE → проверка Wi-Fi не требуется.
- `C7.3`: Если user.work_mode=ONSITE и policy=WIFI_REQUIRED → clock-in разрешён только при успешной проверке сети.
- `C7.4`: AllowedCompanyNetwork редактирует только Owner.
- `C7.5`: Если policy=WIFI_REQUIRED и список разрешённых сетей пуст → clock-in запрещён с понятной причиной.

### Layer D — Edge Cases + “цепочки” ###

## D1. Авто-закрытие активной WorkSession (chain reaction)
Если у сотрудника есть ACTIVE WorkSession, система делает **автоматический clock-out** (закрывает сессию), если произошло одно из событий:
- D1.1: User.status=INACTIVE
- D1.2: TeamMember.status=INACTIVE (сотрудник↔команда проекта)
- D1.3: Project.status=INACTIVE
- D1.4: ProjectTeamAssignment.status=INACTIVE (команда↔проект)
- D1.5: Team.status=INACTIVE

## D2. Как именно закрываем автоматически
- D2.1: end_time = now
- D2.2: WorkSession.status = INACTIVE
- D2.3: duration_ms пересчитывается автоматически
- D2.4: close_reason фиксируется (например: AUTO_USER_DEACTIVATED / AUTO_PROJECT_INACTIVE и т.п.)

## D3. Owner safety
- D3.1: Нельзя деактивировать последнего ACTIVE Owner компании.
- D3.2: Create/Update/Deactivate Admin выполняет только Owner (см. C2.3).

### Layer AUTH / Login / Cookies ###

`AUTH-1`: Login создаёт авторизационное состояние (токены/куки) и даёт доступ в App Area.  
`AUTH-2`: Access token имеет ограниченный TTL (короткий).  
`AUTH-3`: Refresh token имеет больший TTL (длинный).  
`AUTH-4`: Токены хранятся в cookies.  
`AUTH-5`: Logout очищает cookies и делает refresh недействительным.  
`AUTH-6`: Любой запрос в App Area требует валидной авторизации.  
`AUTH-7`: User.status=INACTIVE → доступ запрещён (токены считаются недействительными при проверке).

Важно: `AUTH-сессия` != `WorkSession`.  
WorkSession создаётся только при clock-in.

### Layer Platform-level / Features / Pricing / Trial / PromoCode (это не owner компании, это уровень платформы BarNoneApp) ###

`PLAT-1`: Feature, PricingPlan, PricingPlanBenefit не имеют `company_id`.  
`PLAT-2`: Управлять Feature/Pricing может только Platform Admin.  
`PLAT-3`: При регистрации Company выдаётся trial: `trial_ends_at = now + 1 month`.  
`PLAT-4`: В регистрации можно указать `promo_code` (опционально).  
`PLAT-5`: Генерация promo_code доступна только Platform Admin (не Owner обычной компании). 
`PLAT-6`: Если time.now < Company.trial_ends_at -> доступ разрешен
`PLAT-7`: Если trial закончился и нет активной подписки -> доступ ограничен или закрыт

### Layer E — Billing/Access (trial & promo) ###

## E1. Понятия
- `E1.1`: Trial = бесплатный полный доступ компании на ограниченный срок.
- `E1.2`: PromoCode = код, который даёт компании расширение trial / full access / скидку (типы задаются в PromoCode.type).
- `E1.3`: Feature / PricingPlan / PricingPlanBenefit — platform-level контент (не принадлежат company).

## E2. Trial (на уровне Company)
- `E2.1`: При регистрации Company система устанавливает:
  - Company.subscription_status = TRIAL
  - Company.access_status = FULL
  - Company.trial_ends_at = now + 1 month
- `E2.2`: Пока now < Company.trial_ends_at, Company.access_status = FULL.
- `E2.3`: Когда now >= Company.trial_ends_at и нет активной подписки:
  - Company.subscription_status = EXPIRED
  - Company.access_status = (READ_ONLY или BLOCKED) — выбрать один режим для MVP
- `E2.4`: READ_ONLY означает:
  - можно входить в App Area
  - можно смотреть данные (часы/списки)
  - нельзя создавать/редактировать/деактивировать сущности
  - clock-in / clock-out запрещены

## E3. PromoCode (platform-level)
- `E3.1`: PromoCode создаётся только *Platform Admin* - по сути это админка, но в MVP без нее пока что.
- `E3.2`: PromoCode может иметь ограничения:
  - status (active/inactive)
  - expires_at
  - max_redemptions
- `E3.3`: PromoCode применяется компанией:
  - при регистрации (Sign Up) через поле promo_code
  - (опционально) после регистрации через экран Billing/Access (Owner-only)
- `E3.4`: При применении PromoCode создаётся PromoCodeRedemption (история использования).
- `E3.5`: PromoCode нельзя применить, если:
  - PromoCode.status=inactive
  - now > expires_at (если задан)
  - достигнут max_redemptions

## E4. Эффект от PromoCode.type
- `E4.1`: TRIAL_EXTEND:
  - Company.trial_ends_at = Company.trial_ends_at + value_days
  - Company.access_status становится FULL (если был READ_ONLY/BLOCKED)
  - Company.subscription_status становится TRIAL (если был EXPIRED)
- `E4.2`: FULL_ACCESS:
  - Company.access_status = FULL
  - Company.subscription_status = ACTIVE
  - Company.subscription_name = "Promo Full Access" (или название кода/плана)
  - (опционально) subscription_until_at, если full access не навсегда
- `E4.3`: DISCOUNT:
  - в MVP (без платежей) хранится как “флаг на будущее”, UI может показывать “скидка активна”
  - реальная оплата и расчёт скидки — V2

## E5. Где это видно в UI
- `E5.1`: Owner видит на Dashboard баннер “Trial ends in X days”.
- `E5.2`: Owner видит в Company Settings / Billing & Access:
  - subscription_status
  - access_status
  - trial_ends_at
  - current plan (subscription_name)
- `E5.3`: При EXPIRED:
  - показывается экран/баннер с CTA: “Upgrade / Enter promo / Contact support”.

